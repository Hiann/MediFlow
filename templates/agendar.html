{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <div class="card card-clean border-0">
            <div class="card-header-clean d-flex align-items-center">
                <div class="bg-primary bg-opacity-10 text-primary p-2 rounded-circle me-3">
                    <i class="bi bi-journal-plus fs-5"></i>
                </div>
                <span>Novo Agendamento</span>
            </div>
            
            <div class="card-body p-4 p-md-5">
                <form id="booking-form">
                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold text-uppercase ls-1">Profissional</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-person-badge"></i></span>
                            <select class="form-select border-start-0 ps-0" id="doctor_id" required>
                                <option value="" selected disabled>Selecione o médico...</option>
                                {% for doc in doctors %}
                                    <option value="{{ doc.id }}">{{ doc.name }} &mdash; {{ doc.specialty }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase">Paciente</label>
                            <input type="text" class="form-control" id="patient_name" placeholder="Nome completo" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase">Contato</label>
                            <input type="text" class="form-control" id="patient_phone" placeholder="(00) 00000-0000" required>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label text-muted small fw-bold text-uppercase">Data e Hora</label>
                        <input type="datetime-local" class="form-control" id="date_time" required>
                        <div class="form-text text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i> O sistema verificará conflitos automaticamente.
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-medical py-3 fs-6">
                            Confirmar Agendamento <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Mantive o mesmo script funcional, mas o SweetAlert ficará mais bonito automaticamente
document.getElementById('booking-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Efeito de loading no botão
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Verificando...';
    submitBtn.disabled = true;

    const data = {
        doctor_id: parseInt(document.getElementById('doctor_id').value),
        patient_name: document.getElementById('patient_name').value,
        patient_phone: document.getElementById('patient_phone').value,
        date_time: document.getElementById('date_time').value
    };

    try {
        const res = await fetch('/api/appointments/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (res.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Sucesso!',
                text: 'A consulta foi agendada.',
                background: getComputedStyle(document.body).getPropertyValue('--bg-glass'),
                color: getComputedStyle(document.body).getPropertyValue('--text-main'),
                confirmButtonColor: 'var(--primary-color)'
            }).then(() => window.location.href = '/');
        } else {
            const errorData = await res.json();
            Swal.fire({
                icon: 'warning',
                title: 'Horário Indisponível',
                text: errorData.detail,
                background: getComputedStyle(document.body).getPropertyValue('--bg-glass'),
                color: getComputedStyle(document.body).getPropertyValue('--text-main'),
                confirmButtonColor: 'var(--danger-color)'
            });
        }
    } catch (err) {
        console.error(err);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}